---
layout:       post
title:        "RxObject - Rxç‰ˆçš„ LiveData"
subtitle:     "Make Android Architecture Components Reactive"
date:         2017-12-11 00:00:00
author:       "Guang1234567"
header-img:   "img/in-post/2017-12-11-RxObject/post-bg.jpg"
header-mask:  0.3
catalog:      true
multilingual: false
music-enable: true
music-ids: "[624577, 22667570]"
categories: 
    - Android
    - Android_Architecture
    - RxJava
tags:
    - Android_Architecture_Components
    - Android_Architecture_Components_LiveData
    - RxJava
---


> æ­¤æ–‡ç« ä¸å…è®¸è½¬è½½, è¿è€…å¿…ç©¶...

> ç›®çš„: 

**ç›®å½•:**

* content
{:toc}


## First, What is Android Architecture Components ?

[Android Architecture Components][1]

> - A collection of libraries that help you design robust, testable, and maintainable apps. Start with classes for managing your UI component lifecycle and handling data persistence.
>
>
> - Manage your app's lifecycle with ease
>> New lifecycle-aware components help you manage your activity and fragment lifecycles. Survive configuration changes, avoid memory leaks and easily load data into your UI using LiveData, ViewModel, >> LifecycleObserver and LifecycleOwner.

å¦å¤–,ä¸ºäº†çœ‹æ‡‚ä¸‹é¢çš„å†…å®¹, ä½ éœ€è¦å…ˆå­¦ä¹ è¿™3ä¸ªç©æ„:

- [LiveData - Android Architecture Components][2]  ğŸ‘ˆğŸ¿ æ­¤æ–‡çš„ä¸»è§’, å®ƒæ˜¯è¿™ä¸ª [Android Architecture Components][1] çš„å…¶ä¸­ä¸€ä¸ªé‡è¦ç»„æˆéƒ¨åˆ†.
- [Rxjava2][3]
- [Rxlifecycle2](https://github.com/trello/RxLifecycle)



## ç¼–å†™ RxJava2 ç‰ˆçš„ LiveData


### ä¸ºä»€ä¹ˆä¸ç›´æ¥ç”¨ [LiveData][2], éå¾—è¦å†™ä¸ª Rx ç‰ˆçš„?

1. **[LiveData][2] æ˜¯ä»€ä¹ˆ, å¯ä»¥å¹²ä»€ä¹ˆ?**

    [LiveData][2] = `Live` + `Data`

    `Data` éƒ¨åˆ†åœ¨ Android é‡Œä»£è¡¨ç€`åº”ç”¨æ•°æ®`.  æ¯å½“å®ƒè‡ªèº«å‘ç”Ÿå˜åŒ–æ—¶éƒ½ä¼šå¾€å¤–å‘æ›´æ–°é€šçŸ¥. ç•Œé¢å±‚æ”¶åˆ°é€šçŸ¥åä¼šä½œå‡ºæ›´æ–°çš„ååº”.

    `Live` éƒ¨åˆ†æŒ‡çš„æ˜¯ Android é‡Œ [Activity][5] çš„ç”Ÿæ˜å‘¨æœŸ. å®ƒå¯ä»¥é€šè¿‡ [Lifecycle - Android Architecture Components (å¦å¤–ä¸€ä¸ªç»„æˆéƒ¨åˆ†)][4] ç›‘å¬åˆ° [Activity][5] çš„ç”Ÿæ˜å‘¨æœŸä»è€ŒæŒ‰ç…§æŸç§googleé¢„å…ˆå®šä¹‰çš„è§„åˆ™, é€‰æ‹©æ€§åœ°å»å‘é€šçŸ¥orä¸å‘é€šçŸ¥orå»¶è¿Ÿå‘é€šçŸ¥.


2. **æœ¬äººéå¾—è¦å†™ä¸ª Rx ç‰ˆçš„åŸå› :**

    - å…¶å® [LiveData][2] æœ¬è´¨ä¸Šä¹Ÿæ˜¯ååº”å¼ç¼–ç¨‹çš„äº§ç‰©(å¦å¤–, google å¥½åƒå‡ºäº†ä¸ª [LiveData][2] è½¬æˆ `RxLiveData`çš„å®˜æ–¹åº“), ä½†å´æ˜¯åˆ å‡ç‰ˆä¸èƒ½ç”¨ä¸€ç³»åˆ—çš„æ“ä½œç¬¦.
    - [LiveData][2] çš„ `Live`éƒ¨åˆ†å¥½åƒæ˜¯ä¸ºå¤„ç† [Activity][5] çš„ç”Ÿæ˜å‘¨æœŸç‰¹åŠ çš„åŠŸèƒ½, è¯´å¥½çš„`å•ä¸€èŒè´£`å‘¢?
    - æˆ‘æƒ³ç”¨ [LiveData][2] å‘é€šçŸ¥æ›´æ–°éç•Œé¢çš„æ¨¡å—,æ€ä¹ˆåŠ? è®©éç•Œé¢çš„æ¨¡å—å®ç° [Lifecycle - Android Architecture Components][4] åŠŸèƒ½? <br/> è¿™...åˆ°å¤„éƒ½æ˜¯ç”Ÿå‘½å‘¨æœŸ, What a beautiful work! ğŸ¥

### RxObject æºä»£ç 

```java

    import com.example.myproduct.lib.common.utils.log.Log;

    import java.util.concurrent.TimeUnit;

    import io.reactivex.Flowable;
    import io.reactivex.functions.Consumer;
    import io.reactivex.processors.BehaviorProcessor;
    import io.reactivex.processors.FlowableProcessor;

    /**
     * @author Guang1234567
     * @date 2017/12/7 17:28
     */

    public class RxObject<V> {

        private V mValue;

        private final FlowableProcessor<V> mValueChanged;


        public RxObject() {
            this(null);
        }

        public RxObject(V value) {
            mValue = value;
            if (value != null) {
                mValueChanged = BehaviorProcessor.createDefault(value).toSerialized();
            } else {
                mValueChanged = BehaviorProcessor.<V>create().toSerialized();
            }
        }

        public Flowable<V> getter() {
            synchronized (mValue) {
                return Flowable.just(mValue);
            }
        }

        public V get() {
            synchronized (mValue) {
                return mValue;
            }
        }

        public Consumer<V> setter() {
            return new Consumer<V>() {
                @Override
                public void accept(V value) throws Exception {
                    set(value);
                }
            };
        }

        public void set(V newValue) {
            synchronized (mValue) {
                mValue = newValue;
                mValueChanged.onNext(newValue);
            }
        }

        public Flowable<V> valueChanged() {
            return mValueChanged.hide();
        }

        @Override
        protected void finalize() throws Throwable {
            super.finalize();
            mValueChanged.onComplete();
        }
    }
    
```


### ä½¿ç”¨æ–¹æ³•

<script type="syntaxhighlighter" class="brush: bash; gutter: true; ruler: true; first-line: 1; highlight: [2,6]"><![CDATA[

    class Demo {
        public Demo() {
            RxObject<Long> rxObj = new RxObject<>(-1L);

            // è¾“å…¥ : ä¸åœæ”¹å˜ rxObj instance çš„å€¼.
            Flowable.interval(0, 1, TimeUnit.SECONDS)
                    .take(10)
                    .subscribe(rxObj.setter());

            // è¾“å‡º : ç›‘å¬ rxObj instance çš„å€¼å˜åŒ–
            rxObj.valueChanged().blockingForEach(new Consumer<Long>() {
                @Override
                public void accept(Long aLong) {
                    Log.d("RxObject_Demo", String.valueOf(aLong));
                }
            });
        }
    }

]]></script>

### RxObject å¦‚ä½•ç®¡ç†å…¶ç”Ÿå‘½å‘¨æœŸ?

**ä¸‹é¢çš„ä»£ç ç¤ºä¾‹æè¿°çš„æ˜¯è¿™ä¹ˆä¸€ç§åœºæ™¯:** 

åœ¨ XXX_ViewModel (View Model å±‚) ç›‘å¬æ•°æ®åº“(Model å±‚)çš„å˜åŒ–, å¹¶ä¸”æŠŠå˜åŒ–çš„æ•°æ®å¹¿æ’­åˆ° XXX_Activity (View å±‚).

åŒæ—¶å€ŸåŠ© [Trello å›¢é˜Ÿå‡ºå“çš„ Rxlifecycle2 åº“](https://github.com/trello/RxLifecycle) å»è¿›è¡Œç”Ÿå‘½å‘¨æœŸçš„ç®¡ç†, è¯¦è§ `.compose(bindUntilEvent(ActivityEvent.PAUSE))`
 
**ä»£ç ç¤ºä¾‹:**

<pre class="line-numbers" data-start="1" data-line="3,27-37"><code class="language-java">

    class XXX_ViewModel {

        private RxObject&lt;Long&gt; mData = new RxObject(Long.valueOf(-1L)); 
        
        public XXX_ViewModel {
            // ç›‘å¬æ•°æ®åº“çš„å˜åŒ–, å¹¶æ”¹å˜ mData çš„å€¼
            database.onChanged()
            .subscribe(mData.setter());
        }

        public RxObject&lt;Long&gt; getData() {
            return mData;
        }
    }


    class XXX_Activity {

        private TextView mTV;

        private XXX_ViewModel mViewModel;

        @Override
        protected void onResume() {
            super.onResume();
            
            // ç›‘å¬ XXX_ViewModel#mData çš„å˜åŒ–
            mViewModel.getData().valueChanged()
            .compose(bindUntilEvent(ActivityEvent.PAUSE)) // &lt;-- ç®¡ç†ç”Ÿå‘½å‘¨æœŸ
            .observeOn(RxSchedulers.mainThread()) // ä¸»çº¿ç¨‹æ›´æ–°ç•Œé¢
            .subscribe(new Consumer&lt;Long&gt;() {
                @Override
                public void accept(Long aLong) {
                    // æ›´æ–°æ–‡æœ¬æ¡†
                    mTV.setText(&quot;å½“å‰æ•°å€¼æ˜¯ : &quot; + String.vauleOf(aLong));
                }
            });
        }

        @Override
        protected void onPause() {
            super.onPause();
        }
    }


</code></pre>

## æ€»ç»“

   bye





[1]: https://developer.android.com/topic/libraries/architecture/index.html
[2]: https://developer.android.com/topic/libraries/architecture/livedata.html
[3]: https://github.com/ReactiveX/RxJava
[4]: https://developer.android.com/topic/libraries/architecture/lifecycle.html
[5]: https://developer.android.com/reference/android/app/Activity.html
[6]: https://developer.android.com/reference/android/app/Fragment.html
[7]: https://zh.wikipedia.org/wiki/%E7%BC%96%E7%A8%8B%E8%8C%83%E5%9E%8B

